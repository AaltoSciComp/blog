<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="What code has to teach us #1: the impact of implicit behavior" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://aaltoscicomp.github.io/blog/2021/04/what-code-has-to-teach-us-1/" />
<meta property="og:site_name" content="Aalto SciComp Blog" />
<meta property="og:description" content="“The master has failed more times than the beginner has even tried”, – Stephen McCranie, As Research Software Engineers (RSEs), we read and write a lot of code. In this series of blog posts, we are..." />
<meta property="og:image" content="https://scicomp.aalto.fi/_static/asc-socialshare-02.png" />
<meta property="og:image:alt" content="ASC hexagon logo; Aalto Scientific Computing; Data, Software, Computing, HPC, and Training." />
<meta name="description" content="“The master has failed more times than the beginner has even tried”, – Stephen McCranie, As Research Software Engineers (RSEs), we read and write a lot of code. In this series of blog posts, we are..." />
<meta property="twitter:creator" content="@SciCompAalto" />

    <title>What code has to teach us #1: the impact of implicit behavior &#8212; Aalto Scientific Computing Blog  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_rtd_theme_ext_color_contrast.css?v=8e8ea19f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <script src="../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../../_static/documentation_options.js?v=187304be"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script data-domain="aaltoscicomp.github.io" defer="defer" src="https://plausible.cs.aalto.fi/js/script.js"></script>
    <link rel="icon" href="../../../_static/logo-hexagons-02-compact.svg.ico"/>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" /> 
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  
 
<link
  rel="alternate"
  type="application/atom+xml"
  href="../../../blog/atom.xml"
  title="Aalto Scientific Computing Blog"
/>
  
  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
             <section id="what-code-has-to-teach-us-1-the-impact-of-implicit-behavior">
<h1>What code has to teach us #1: the impact of implicit behavior<a class="headerlink" href="#what-code-has-to-teach-us-1-the-impact-of-implicit-behavior" title="Link to this heading"></a></h1>
<blockquote>
<div><div class="line-block">
<div class="line">“The master has failed more times than the beginner has even tried”</div>
<div class="line">– Stephen McCranie</div>
</div>
</div></blockquote>
<p>As Research Software Engineers (RSEs), we read and write a lot of code.
In this series of blog posts, we are going to share some snippets that taught us important lessons, and thereby impart that wisdom unto you.
These snippets are taken from actual research code, responsible for producing results that end up in peer-reviewed scientific articles.
That is to say, results that we should have some confidence in to be correct.
However, problems have a way of cropping up in the most unexpected places and when they do, there is a chance to learn from them.</p>
<section id="the-impact-of-implicit-behavior">
<h2>The impact of implicit behavior<a class="headerlink" href="#the-impact-of-implicit-behavior" title="Link to this heading"></a></h2>
<p>I was in the metro zooming through Lauttasaari when I received an email from my professor that made my heart skip a beat.
We just submitted a paper to Nature Communications and were all still a little giddy about finally sending off the project we had been working on for 3 years.
She and the first author had been chatting about the cool methods we had been using for the project and a question arose: were we 100% certain that we “removed copies of the selected stimuli from the train set”?
If we hadn’t, we would have to quickly pull back our submission, but surely we had, right?
I thought we did.
At least, I distinctly remember writing the code to do it.
Just to be on the safe side, I decided to double check the code.</p>
<p>Below is the analysis script in question.
It reads some data, performs some preprocessing, feeds into the a machine learning algorithm called <code class="docutils literal notranslate"><span class="pre">zero_shot_decoding</span></code>, and stores the output.
I present it here to you in full, because there are many subtleties working together that make this situation so scary.
The question I pose to you, dear reader, is this: were the highlighted lines (118–120) executed, or did we have to pull our submission?</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span> <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos">  2</span> <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">loadmat</span><span class="p">,</span> <span class="n">savemat</span>
<span class="linenos">  3</span> <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">zscore</span>
<span class="linenos">  4</span> <span class="kn">from</span><span class="w"> </span><span class="nn">zero_shot_decoding</span><span class="w"> </span><span class="kn">import</span> <span class="n">zero_shot_decoding</span>
<span class="linenos">  5</span> <span class="c1">#print(&#39;Code version:&#39;+ subprocess.check_output([&#39;git&#39;, &#39;rev-parse&#39;, &#39;HEAD&#39;]))</span>
<span class="linenos">  6</span>
<span class="linenos">  7</span> <span class="c1"># Default location of the norm data (see also the --norms command line parameter)</span>
<span class="linenos">  8</span> <span class="n">norm_file</span> <span class="o">=</span> <span class="s1">&#39;../data/corpusvectors_ginter_lemma.mat&#39;</span>
<span class="linenos">  9</span>
<span class="linenos"> 10</span> <span class="c1"># Handle command line arguments</span>
<span class="linenos"> 11</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Run zero-shot learning on a single subject.&#39;</span><span class="p">)</span>
<span class="linenos"> 12</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;input_file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 13</span>                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The file that contains the subject data; should be a .mat file.&#39;</span><span class="p">)</span>
<span class="linenos"> 14</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--subject-id&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;Subject ID&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 15</span>                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The subject-id (as string). This number is recorded in the output .mat file.&#39;</span><span class="p">)</span>
<span class="linenos"> 16</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--norms&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">norm_file</span><span class="p">,</span>
<span class="linenos"> 17</span>                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The file that contains the norm data. Defaults to </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">norm_file</span><span class="p">)</span>
<span class="linenos"> 18</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;results.mat&#39;</span><span class="p">,</span>
<span class="linenos"> 19</span>                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The file to write the results to; should end in .mat. Defaults to results.mat&#39;</span><span class="p">)</span>
<span class="linenos"> 20</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
<span class="linenos"> 21</span>                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to show a progress bar&#39;</span><span class="p">)</span>
<span class="linenos"> 22</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--break-after&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="linenos"> 23</span>                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Break after N iterations (useful for testing)&#39;</span><span class="p">)</span>
<span class="linenos"> 24</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--n_voxels&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;N voxels&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
<span class="linenos"> 25</span>                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of voxels. Used only for results file name.&#39;</span><span class="p">)</span>
<span class="linenos"> 26</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--distance-metric&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span>
<span class="linenos"> 27</span>                     <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;The distance metric to use. Any distance implemented in SciPy&#39;s &quot;</span>
<span class="linenos"> 28</span>                           <span class="s2">&quot;spatial.distance module is supported. See the docstring of &quot;</span>
<span class="linenos"> 29</span>                           <span class="s2">&quot;scipy.spatial.distance.pdict for the exhaustive list of possitble &quot;</span>
<span class="linenos"> 30</span>                           <span class="s2">&quot;metrics. Here are some of the more useful ones: &quot;</span>
<span class="linenos"> 31</span>                           <span class="s2">&quot;&#39;euclidean&#39; - Euclidean distance &quot;</span>
<span class="linenos"> 32</span>                           <span class="s2">&quot;&#39;sqeuclidean&#39; - Squared euclidean distance &quot;</span>
<span class="linenos"> 33</span>                           <span class="s2">&quot;&#39;correlation&#39; - Pearson correlation &quot;</span>
<span class="linenos"> 34</span>                           <span class="s2">&quot;&#39;cosine&#39; - Cosine similarity (the default)&quot;</span><span class="p">))</span>
<span class="linenos"> 35</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span>
<span class="linenos"> 38</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">break_after</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 39</span>     <span class="n">break_after</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">break_after</span>
<span class="linenos"> 40</span> <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 41</span>     <span class="n">break_after</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Subject:&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">subject_id</span><span class="p">)</span>
<span class="linenos"> 44</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input:&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">input_file</span><span class="p">)</span>
<span class="linenos"> 45</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output:&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
<span class="linenos"> 46</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Norms:&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">norms</span><span class="p">)</span>
<span class="linenos"> 47</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Distance metric:&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">distance_metric</span><span class="p">)</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span> <span class="n">m</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input_file</span><span class="p">)</span>
<span class="linenos"> 51</span> <span class="k">if</span> <span class="s1">&#39;brainVecsReps&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
<span class="linenos"> 52</span>     <span class="c1"># File without stability selection enabled</span>
<span class="linenos"> 53</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stability selection DISABLED&#39;</span><span class="p">)</span>
<span class="linenos"> 54</span>     <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;brainVecsReps&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;brainVecsReps&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
<span class="linenos"> 55</span>     <span class="n">n_repetitions</span><span class="p">,</span> <span class="n">n_stimuli</span><span class="p">,</span> <span class="n">n_voxels</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos"> 56</span>     <span class="n">voxel_ids</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span>     <span class="c1"># Drop all voxels that contain NaN&#39;s for any items</span>
<span class="linenos"> 59</span>     <span class="n">non_nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 60</span>     <span class="n">non_nan_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">non_nan_mask</span><span class="p">)</span>
<span class="linenos"> 61</span>     <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">non_nan_mask</span><span class="p">]</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span>     <span class="c1"># Normalize betas across items</span>
<span class="linenos"> 64</span>     <span class="n">X</span> <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span>     <span class="c1"># Average over the repetitions</span>
<span class="linenos"> 67</span>     <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span>     <span class="n">X_perm</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 70</span>     <span class="n">splits</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span> <span class="k">elif</span> <span class="s1">&#39;mask_voxels&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
<span class="linenos"> 73</span>     <span class="c1"># File without stability selection enabled</span>
<span class="linenos"> 74</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stability selection DISABLED&#39;</span><span class="p">)</span>
<span class="linenos"> 75</span>     <span class="n">X</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;mask_voxels&#39;</span><span class="p">]</span>
<span class="linenos"> 76</span>     <span class="n">voxel_ids</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;voxel_ids&#39;</span><span class="p">]</span>
<span class="linenos"> 77</span>     <span class="n">n_stimuli</span><span class="p">,</span> <span class="n">n_voxels</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos"> 78</span>     <span class="n">X_perm</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 79</span>     <span class="n">splits</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span> <span class="k">elif</span> <span class="s1">&#39;top_voxels_perm&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
<span class="linenos"> 82</span>     <span class="c1"># File with stability selection enabled</span>
<span class="linenos"> 83</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stability selection ENABLED&#39;</span><span class="p">)</span>
<span class="linenos"> 84</span>     <span class="n">X_perm</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;top_voxels_perm&#39;</span><span class="p">]</span>
<span class="linenos"> 85</span>     <span class="n">X</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;top_voxels_all&#39;</span><span class="p">]</span>
<span class="linenos"> 86</span>     <span class="n">voxel_ids</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;top_voxel_ids&#39;</span><span class="p">]</span>
<span class="linenos"> 87</span>     <span class="n">n_stimuli</span><span class="p">,</span> <span class="n">n_voxels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">X_perm</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span>     <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;leave2out_index.npy&#39;</span><span class="p">)</span>
<span class="linenos"> 90</span>     <span class="n">splits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;leave2out_index.npy&#39;</span><span class="p">)</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span> <span class="k">elif</span> <span class="s1">&#39;brainVecs&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
<span class="linenos"> 93</span>     <span class="c1"># File with single-trial data</span>
<span class="linenos"> 94</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stability selection DISABLED, single-trial data&#39;</span><span class="p">)</span>
<span class="linenos"> 95</span>     <span class="n">X</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;brainVecs&#39;</span><span class="p">]</span>
<span class="linenos"> 96</span>     <span class="n">voxel_ids</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;voxindex&#39;</span><span class="p">]</span>
<span class="linenos"> 97</span>     <span class="n">n_stimuli</span><span class="p">,</span> <span class="n">n_voxels</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos"> 98</span>     <span class="n">X_perm</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span>     <span class="k">def</span><span class="w"> </span><span class="nf">generate_splits</span><span class="p">(</span><span class="n">n_stimuli</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="linenos">101</span><span class="w">         </span><span class="sd">&quot;&quot;&quot;Generate train-set, test-set splits.</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="sd">         To save computation time, we don&#39;t do the full 360*359/2 iterations.</span>
<span class="linenos">104</span><span class="sd">         Instead we will do the leave-2-out scheme block-wise and use the rest</span>
<span class="linenos">105</span><span class="sd">         of the data for training.</span>
<span class="linenos">106</span><span class="sd">         &quot;&quot;&quot;</span>
<span class="linenos">107</span>         <span class="k">assert</span> <span class="n">n_stimuli</span> <span class="o">%</span> <span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span>
<span class="linenos">108</span>         <span class="n">n_blocks</span> <span class="o">=</span> <span class="n">n_stimuli</span> <span class="o">//</span> <span class="n">block_size</span>
<span class="linenos">109</span>         <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_stimuli</span><span class="p">):</span>
<span class="linenos">110</span>             <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_stimuli</span><span class="p">):</span>
<span class="linenos">111</span>                 <span class="c1"># Don&#39;t make the model distinguish between duplicate stimuli</span>
<span class="linenos">112</span>                 <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="n">block_size</span> <span class="o">==</span> <span class="n">y</span> <span class="o">%</span> <span class="n">block_size</span><span class="p">:</span>
<span class="linenos">113</span>                     <span class="k">continue</span>
<span class="linenos">114</span>
<span class="linenos">115</span>                 <span class="n">test_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
<span class="linenos">116</span>                 <span class="n">train_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_stimuli</span><span class="p">),</span> <span class="n">test_set</span><span class="p">)</span>
<span class="linenos">117</span>
<span class="hll"><span class="linenos">118</span>                 <span class="c1"># Remove copies of the selected stimuli from the train set</span>
</span><span class="hll"><span class="linenos">119</span>                 <span class="n">train_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">block_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="n">block_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_blocks</span><span class="p">)])</span>
</span><span class="hll"><span class="linenos">120</span>                 <span class="n">train_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">block_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">%</span> <span class="n">block_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_blocks</span><span class="p">)])</span>
</span><span class="linenos">121</span>
<span class="linenos">122</span>                 <span class="k">yield</span> <span class="n">train_set</span><span class="p">,</span> <span class="n">test_set</span>
<span class="linenos">123</span>
<span class="linenos">124</span>     <span class="n">splits</span> <span class="o">=</span> <span class="n">generate_splits</span><span class="p">(</span><span class="n">n_stimuli</span><span class="p">)</span>
<span class="linenos">125</span>
<span class="linenos">126</span> <span class="k">else</span><span class="p">:</span>
<span class="linenos">127</span>     <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Could not find any suitable data in the supplied input file.&#39;</span><span class="p">)</span>
<span class="linenos">128</span>
<span class="linenos">129</span> <span class="c1"># Load the norm data</span>
<span class="linenos">130</span> <span class="n">m</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">norms</span><span class="p">)</span>
<span class="linenos">131</span> <span class="n">y</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;newVectors&#39;</span><span class="p">]</span>
<span class="linenos">132</span>
<span class="linenos">133</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<span class="linenos">134</span>     <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The norm data contains NaNs or Infs.&#39;</span><span class="p">)</span>
<span class="linenos">135</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<span class="linenos">136</span>     <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The brain data contains NaNs or Infs.&#39;</span><span class="p">)</span>
<span class="linenos">137</span>
<span class="linenos">138</span> <span class="n">pairwise_accuracies</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">target_scores</span><span class="p">,</span> <span class="n">predicted_y</span><span class="p">,</span> <span class="n">patterns</span> <span class="o">=</span> <span class="n">zero_shot_decoding</span><span class="p">(</span>
<span class="linenos">139</span>     <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">X_perm</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">break_after</span><span class="o">=</span><span class="n">break_after</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">distance_metric</span><span class="p">,</span> <span class="n">cv_splits</span><span class="o">=</span><span class="n">splits</span>
<span class="linenos">140</span> <span class="p">)</span>
<span class="linenos">141</span>
<span class="linenos">142</span> <span class="n">savemat</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="p">{</span>
<span class="linenos">143</span>     <span class="s1">&#39;pairwise_accuracies&#39;</span><span class="p">:</span> <span class="n">pairwise_accuracies</span><span class="p">,</span>
<span class="linenos">144</span>     <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span>
<span class="linenos">145</span>     <span class="s1">&#39;feat_scores&#39;</span><span class="p">:</span> <span class="n">target_scores</span><span class="p">,</span>
<span class="linenos">146</span>     <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">subject_id</span><span class="p">,</span>
<span class="linenos">147</span>     <span class="s1">&#39;inputfile&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">input_file</span><span class="p">,</span>
<span class="linenos">148</span>     <span class="s1">&#39;alphas&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">alpha_</span><span class="p">,</span>
<span class="linenos">149</span>     <span class="s1">&#39;voxel_ids&#39;</span><span class="p">:</span> <span class="n">voxel_ids</span><span class="p">,</span>
<span class="linenos">150</span>     <span class="s1">&#39;predicted_y&#39;</span><span class="p">:</span> <span class="n">predicted_y</span><span class="p">,</span>
<span class="linenos">151</span>     <span class="s1">&#39;patterns&#39;</span><span class="p">:</span> <span class="n">patterns</span><span class="p">,</span>
<span class="linenos">152</span> <span class="p">})</span>
</pre></div>
</div>
</section>
<section id="lessons-this-code-has-to-teach-us">
<h2>Lessons this code has to teach us<a class="headerlink" href="#lessons-this-code-has-to-teach-us" title="Link to this heading"></a></h2>
<p>The first thing that went through my head, as it probably went through yours, was: this code is so long and complicated, answering this seemingly simple question is going to take some time to figure out.
And I won’t blame you for giving up right then and there.
Hunched over my laptop while the metro passed through Ruoholahti, I tried to trace the logic of the script.</p>
<p>First problem: much of the behavior of the script is dictated by the command line arguments.
Luckily, their values are saved in the output file, so I could check that they were correct.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Lesson:</strong> always error on the side of caution when deciding whether it is worth storing something in the result file.</p>
</div>
<p>That brings us to the big <code class="docutils literal notranslate"><span class="pre">if</span></code>-statement.
Did the correct branch execute?
Well, that depends on what was in the <code class="docutils literal notranslate"><span class="pre">m</span></code> dictionary, which translates to what variables were defined in the MATLAB file used as input to the script.
If we had used the wrong variable name, i.e. <code class="docutils literal notranslate"><span class="pre">brainVecsReps</span></code> instead of <code class="docutils literal notranslate"><span class="pre">brainVecs</span></code>, when creating the input file, the wrong branch would have executed and the script would have been happily computing the wrong thing.
And we would never know.
If we had used the wrong input file, or the wrong version of the input file, the wrong branch would have executed without any indication that something was wrong.
So many opportunities for small mistakes to lead to a big error.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Lesson:</strong> have the user be explicit in what they want to do, so the script can check the user’s intent against the inputs and raise a nice big error if they screwed up.
In this case, there should really have been either a command line parameter determining which branch to execute, or even better, this should have been four separate scripts.</p>
</div>
<p>In the end I ended up searching the logfile for the line <code class="docutils literal notranslate"><span class="pre">Stability</span> <span class="pre">selection</span> <span class="pre">DISABLED,</span> <span class="pre">single-trial</span> <span class="pre">data</span></code> which, thankfully, was there, so the correct branch did execute.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Lesson:</strong> be liberal with <code class="docutils literal notranslate"><span class="pre">print</span></code>-statements (or other logging directives) in your scripts; cherish the resulting logfiles.</p>
</div>
<p>I breathed a sigh of relieved as the metro pulled into the central railway station.</p>
<p>This <code class="docutils literal notranslate"><span class="pre">if</span></code>-statement is a work of insanity.
What was I thinking determining what the script should be doing based on a mostly random naming scheme of some variables in a MATLAB file?
I got lucky that time.
But from that moment on, I would heed this lesson:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line">Explicit is better than implicit.</div>
<div class="line">– The Zen of Python, by Tim Peters</div>
</div>
</div>
</section>
</section>

<div class="section ablog__blog_comments">
     
<div class="section ablog__prev-next">
  <span class="ablog__prev">
    
  </span>
  <span class="ablog__spacer">&nbsp;</span>
  <span class="ablog__next">
      Next: 
    <a href="../../../2023/stickers/">
      <span>Aalto SciComp stickers and patches</span>
      
    </a>
    
  </span>
</div>
  
</div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><h1 style="text-align: center; margin-top: 0px">
  <a href="../../../">Aalto Scientific Computing Blog</a>
</h1>
<ul>
<li><a href="https://scicomp.aalto.fi">Home</a></li>
<li><a href="../../../blog/atom.xml">Blog feed</a></li>
<li><a href="https://fosstodon.org/@SciCompAalto">Mastodon</a></li>
<li><a href="https://twitter.com/SciCompAalto">Twitter</a></li>
</ul>
<div class="ablog-sidebar-item ablog__postcard">
   
  <h2>
     
    <span>2021 Apr 14</span>
    
  </h2>
  <ul>
    <div class="ablog-sidebar-item ablog__postcard2">
   
  <li id="ablog-sidebar-item author ablog__author">
    <span>
       Author: 
    </span>
     
    <a href="../../../blog/author/marijn-van-vliet/">Marijn van Vliet</a>
      
  </li>
     
  <li id="ablog-sidebar-item category ablog__category">
    <span>
       Category: 
    </span>
     
    <a href="../../../blog/category/python/">python</a>
      
  </li>
    
</div>
  </ul>
</div>

<div class="ablog-sidebar-item ablog__recentposts">
  <h3>
    <a href="../../../blog/">Recent Posts</a>
  </h3>
  <ul>
     
    <li>
      <a href="../../../2025/ucl-rse-visit/">
        08 May - RSE report from visiting University College London Advanced Research Computing
      </a>
    </li>
    
    <li>
      <a href="../../../2024/what-is-a-rse/">
        20 November - What is a Research Software Engineer?
      </a>
    </li>
    
    <li>
      <a href="../../../2024/how-busy-is-the-cluster/">
        21 October - How busy is the cluster?  A discussion
      </a>
    </li>
    
    <li>
      <a href="../../../2024/rse-work-rotations/">
        08 October - RSE work rotations
      </a>
    </li>
    
    <li>
      <a href="../../../2024/rse-collaboration/">
        08 October - Future RSE collaboration in Finland
      </a>
    </li>
    
  </ul>
</div>

<div class="ablog-sidebar-item ablog__categories">
  <h3>
    <a href="../../../blog/category/">Categories</a>
  </h3>
  <ul>
     
    <li>
      <a href="../../../blog/category/ai/">AI (1)</a>
    </li>
      
    <li>
      <a href="../../../blog/category/asc/">ASC (4)</a>
    </li>
      
    <li>
      <a href="../../../blog/category/aalto/">aalto (1)</a>
    </li>
      
    <li>
      <a href="../../../blog/category/python/">python (1)</a>
    </li>
      
    <li>
      <a href="../../../blog/category/rse/">rse (6)</a>
    </li>
      
    <li>
      <a href="../../../blog/category/security/">security (1)</a>
    </li>
      
    <li>
      <a href="../../../blog/category/software/">software (1)</a>
    </li>
      
    <li>
      <a href="../../../blog/category/ssh/">ssh (1)</a>
    </li>
      
    <li>
      <a href="../../../blog/category/teaching/">teaching (2)</a>
    </li>
      
    <li>
      <a href="../../../blog/category/triton/">triton (5)</a>
    </li>
      
    <li>
      <a href="../../../blog/category/whisper/">whisper (1)</a>
    </li>
     
  </ul>
</div>

<div class="ablog-sidebar-item ablog__archives">
  <h3>
    <a href="../../../blog/archive/">Archives</a>
  </h3>
  <ul>
     
    <li>
      <a href="../../../blog/2025/">2025 (1)</a>
    </li>
      
    <li>
      <a href="../../../blog/2024/">2024 (8)</a>
    </li>
      
    <li>
      <a href="../../../blog/2023/">2023 (9)</a>
    </li>
      
    <li>
      <a href="../../../blog/2021/">2021 (1)</a>
    </li>
     
  </ul>
</div>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2021-2023, Aalto Scientific Computing.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../../_sources/2021/04/what-code-has-to-teach-us-1.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>